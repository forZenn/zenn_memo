---
title: "nodejsのソースコードのビルド"
emoji: "🦁"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["javascript", "nodejs", "cpp"]
published: true
published_at: 2023-08-01 19:00 
---

今現在(2023-08-01)raspbian はbullseyeベースなのでaptでnodejsをインストールするとnodejs12が入ります。
ただ、zenn-cliがnodejs12以下はサポート切ってたりで、bullseyeのnpmからzenn-cliをインストールしようとすると怒られます。一応zenn-cliは入りますが、警告だが、非推奨だかのメッセージが出ます。

よってraspberry piからapt->npm->zenn-cliという感じに怒られずにええ感じにインストールできない。
単純にnodejs関連のパッケージだけstable bookwormのレポジトリを向くようにしてもいいですが、それでも最新のLTSでないし、どうせ最新のLTS使わないならまあせっかく?なんでビルドしましょうと思ってやってみました。

## 前提条件

github cliインストール済み
tmuxインストール済み。
sysstatインストール済み（統計取るのに必須。特に取るつもりがないなら不要）。

## ソースコードの準備

```bash
# gh repo clone用のディレクトリ作成
mkdir ~/src
cd src
```

githubからーソースコードをダウンロードする

```bash
gh repo clone nodejs/node

cd node
# タグ一覧表示　
git tag

# 使いたいバージョンのタグにcheckout
git checkout v18.9.1
```

以下はプロジェクト直下にいることを前提に説明していきます。

## ビルド方法

ビルド方法はnodejsの場合はBUILDING.mdに書いてあります。
大抵のプロジェクトにはローカルのビルド方法が書いてあるので、その通りにやってください。
無い場合はソースコードを読んだり、実際ビルドしたときにエラーが出るlibファイルを見たり、Makefile読んだりで自分で調べましょう。
古いプロジェクトでない限り、どこかにやり方が書かれていて、How to的な環境は整っていると思います。

nodejsの説明はかなり丁寧なので、わかりやすいです。Readmeや環境構築の説明の書き方の例として参考にしたらいいかも。

### 依存関係

BUILDING.mdに書いてある通り、Debianは下のようなパッケージが必要です。

```bash
sudo apt install python3 g++ make python3-pip
```

### configure

ビルドするときのconfigです。
特に気にしなくていいです。

```bash
./configure
```

### build

tmuxで起動
これはssh経由でビルドしていたりして、sshのセッションが中断されることにより、
処理が中断されないように必要です。
tmuxである必要はありませんが、一番考えなくてもいいのがtmuxですし、愛好家は多いのでこれを使うのが良いかと。
tmuxで適当なセッション作っておきましょう。

```bash
tmux
```

### ログ置き場

とりあえずビルドして使うだけでも結構時間がかかるので、ログだけは最低でもとっておいた方が
良いと思います。流れてなくなってしまうので。

ログの場所はどこでもいいですが、自分は特に指定がないなら、一般ユーザーでビルドするときは
~/var/log/プロジェクト名/make
みたいなディレクトリを作ってそこに書き込んでいます。
ここではとりあえず、この場所をログ保管場所としておきましょう。

```bash
mkdir -p ~/var/log/node/make
```

### help

Makefileにはhelpが書かれているので、一度見てみましょう。

```bash
# make --helpでなくて、make helpであることに注意。
# make --helpだとmakeコマンドのhelpがでる。
make help
```

make installでdefaultのインストール先が/usr/localであることや、
make cleanでキャッシュの削除ができること、
make uninstallがあることを確認します(make uninstallできないプロジェクトもある)。

### ビルドしてみる

Makefileをビルドしてみます。
何も引数がない場合はmake allとなってすべてビルドするみたいですね。

make -jはビルドするときのjob数の指定です。コア数に応じたjob数を選んでください。

ここではBUILDING.mdにはmake -j4としてビルドせよと書かれていますが、
raspberry piみたいに貧弱なpcなら-j2, -j3の方がいいかも。
これは貧弱なpcだとバックグラウンドの処理が相対的に重くなっているので、ビルド中にデスクトップが止まったりクラッシュする可能性があるためです。

ここら辺は実際にその環境で実行しないとわからないと思います。

コア数が気になるならlscpuや/proc/cpuinfoを見てコア数を調査しておきましょう。

ビルドのログは流れてしまうので下のようにログを取るのがいいかと。
こうしないと失敗時の切り戻しが面倒です。

```bash
# こうすると時間経過もログに残せる。
make -j4 2>&1 | awk '{print strftime("%Y-%m-%d%H%M%S"), $0}' | tee ~/var/log/node/make/"$(date +'%Y%m%dT%H%M%SZ')".log
```

pcのスペック的にしんどいかも知りたい人はこの時にtmuxで別セッションを開いておき、
負荷を調べておきましょう。何度もビルドする可能性があるなら測った方がいいです。

```bash
mkdir -p ~/var/log/iostat/
# これをやると1秒間に一回、cpuやディスクioの統計をとってくれる。
iostat -x 1 | awk '{print strftime("%Y-%m-%d%H%M%S"), $0}' | tee ~/var/log/iostat/"$(date +'%Y%m%dT%H%M%SZ')".log
```

ビルドが始まったら、tmuxをデタッチ、sshを終了して、ビルドが終わるまでほっときましょう。

### ビルド時間中に豆知識

cppをやったことない人はびっくりすると思いますが、warning出まくります。
また、膨大な量のログが出るのでびっくりすると思いますが、よくあることです。
正常なので、とくにエラーで停止しない限りほっときましょう。

自分がraspberry pi4Bでビルドしたところ、3時間から4時間ほどで
iostatで調べるとユーザーレベルでcpuが常に90%代でした。
rasperry pi はmicrosdカードにデータがあるので、ディスクioもある程度ネックになるかと思いましたが、iowaitがほとんど無かったので、統計的にはcpuの方が足引っ張ってますね。

負荷を少しでも下げたい場合、特にraspberrypi でビルドしている人はGUIを切ってやった方がいいかも。
私はraspberry pi4Bで最初にビルドした場合はクラッシュしたのでsystemctl set-default multi-user.targetとしてcuiにしてビルドしなおしました。

これらの数値はあくまで私の環境での話であり、高温、低温下や、microsdカードの空き容量や種類によるストレージの速度、電源が足りているかなどでも速度は変わると思います。
参考までに。

ただ、最新のPCなら30分から１時間で終わりそうなので、新しいPC使っている人はあまり気にしなくていい気もします。

## 出来立てほやほやを使ってみる

ビルドできたなら使ってみます。
下記のコマンドを実行すると対話形式で立ち上がると思います。

```bash
./out/Realease/node
```

リリースバージョンかつbookwormでも採用されたバージョンなので大丈夫だと思いますが、make installする前に軽く動作確認しときましょう。

## install

インストール場所にインストールします。
実行すると依存関係を考えて、binや、includeなどを適切な場所に入ります。
これは2~5分程度で終わります。

aptやdnfなどパッケージ管理ツールでなくMakefileでビルドしたなど、自分で勝手に入れたものはlinuxでは/usr/local/配下に入れるのが普通です。
先ほどの説明通り、下のコマンドを実行すると/usr/local/に各ファイルが入ります。

```bash
sudo make install
```


## /usr/local/にインストールされたものを使ってみる

/usr/local/binにパスが通っていたら、ちゃんと実行できるはずです。

```bash
# 存在確認
command -v npm
command -v node

## 対話形式で実行してみる。
node

## zenn-cliをインストールしてみる。
sudo npm install -g zenn-cli
```

## uninstall

Makefileによってはアンインストール方法が無いものもあります。
その場合は手動で消すことになりますが、nodejsはuninstallができるように書かれているので、
Makefileの場所で以下のようにすればアンインストールされます。

```bash
sudo make uninstall
```

## updateしたい

アンインストールしてから、クリーン、gitで適切なバージョン、
configure, make,make installとします。

cleanしてから、gitで適切なバージョンにチェックアウトして
make installで上書きという形だとシステムに前のバージョンの依存関係のライブラリが残ります。
気をつけましょう。

```bash
## 残っているプロジェクトのMakefileを使ってアンインストール
sudo make uninstall

# キャッシュクリーン
make clean

# 使いたいバージョンにチェックアウト
git checkout v{適切なバージョン}

./configure

make 

sudo make install
```

## まとめ

手順に沿ってやれば出来るので、
特に難しい点は無いと思います。

なんとなく気がついたかと思いますが、Makefileでinstallするならプロジェクトを持っておかないと、
アンインストールとupdate時に困ります。プロジェクトは持っておきましょう。

上の手順で実行したら、ビルド時にどの程度負荷がかかっていたのかわかるので、
「俺はnodejsに貢献したい！」とか、「JS王に俺はなる！」みたいな人は負荷が多過ぎたら、
時間がかかり過ぎてやってられないと思います。
おとなしくnodejs自体の開発環境用のPC買いましょう。
