---
title: "dotnetã§Unixã€Windowsä¸¡æ–¹ã®ç’°å¢ƒã§ç®¡ç†è€…æ¨©é™ã‹ã©ã†ã‹ã®ãƒã‚§ãƒƒã‚¯"
emoji: "ğŸ¤–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["csharp", "dotnet", "windows", "linux"]
published: true
---

ã¨ã‚Šã¾çµè«–ã€‚
ç´°ã‹ã„æ–‡ç« æ ¡æ­£ã¯å¾Œã§ã—ã¾ã™ã€‚

ifãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã§UNIXã‹ã©ã†ã‹ã®åˆ¤å®šã¯Powershellã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã§ã‚‚å…¨ä½“ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹ã€‚
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«UNIXã¨Windowsã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒã©ã†ã—ã¦ã‚‚ã‹ãªã‚Šæ··ã–ã‚‹ã€å¤§è¦æ¨¡ãªã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã ã¨ã»ã¼å¿…é ˆã€‚

ifãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã§Unixã¨ã‚ã‘ãªã„ã¨è¦–è¦šçš„ã«Unixã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‹ã©ã†ã‹ã‚’è¦‹åˆ†ã‘ã‚‹ã®ãŒå¤§å¤‰ï¼ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã§ãªãã¦ifã¨ã„ã†å½¢ã§æ•£ã‚‰ã°ã‚‹ãŸã‚ã€‚ï¼‰ã€‚
ã¡ã‚ƒã‚“ã¨ã‚„ã‚‹ã¨ifãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã§ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰æŠ˜ã‚Šç•³ã‚ã‚‹ã‚ˆã†ã«ãªã‚‹ã—ã€ç›®ã«ã‚‚å„ªã—ããªã‚‹ã€‚

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ã„ãŸãŒã€å„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ãªãã¦ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ç›´ä¸‹ã«propsã¨ã—ã¦æŒã£ã¦ãŠãã¹ãã€‚

```xml:cli.csproj
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <OutputType>Exe</OutputType>
    <TargetFramework>net7.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>
  <!-- #if UNIX, #if !UNIX ã¨ifãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã§ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’åˆ†ã‘ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚ -->
  <PropertyGroup>
    <DefineConstants>$(DefineConstants);CORECLR</DefineConstants>
    <IsWindows Condition="'$(IsWindows)' =='true' or ( '$(IsWindows)' == '' and '$(OS)' == 'Windows_NT')">true</IsWindows>
  </PropertyGroup>

  <!-- Define non-windows, all configuration properties -->
  <PropertyGroup Condition=" '$(IsWindows)' != 'true' ">
    <DefineConstants>$(DefineConstants);UNIX</DefineConstants>
  </PropertyGroup>

</Project>
```

```csharp
using System.Diagnostics;
using System;
using System.Threading;
using System.Security.Permissions;
using System.Security.Principal;
using Microsoft.CSharp.RuntimeBinder;

internal class Program
{
    /// <summary>
    /// check Administrator priviledge.
    /// </summary>
    /// <exception cref="RuntimeBinderException">unixç’°å¢ƒä¸‹ã«ãŠã„ã¦uidã®å–å¾—å¤±æ•—</exception>
    /// <exception cref="IOException">unixç’°å¢ƒä¸‹ã«ãŠã„ã¦uidå–å¾—æ™‚ã®IOError</exception>
    /// <exception cref="NullReferenceException">windowsç’°å¢ƒä¸‹ã«ãŠã„ã¦CurrentPrincipalã®å–å¾—å¤±æ•—</exception>
    /// <returns>If Administrator or root user, return true.</returns>
    public static bool IsAdministrator()
    {

        bool judge = false;
#if UNIX
        ProcessStartInfo processStartInfo = new() {
            FileName = "id",
            Arguments = "-u",
            CreateNoWindow = true,
            RedirectStandardOutput = true,
            UseShellExecute = false,
        };
        string uidln = string.Empty;
        try
        {
            using Process process = new();
            process.StartInfo = processStartInfo;
            process.Start();
            process.WaitForExit();
            uidln = process.StandardOutput.ReadToEnd();

            if (uidln.Length < 1 || process.ExitCode != 0) 
            {
                throw new RuntimeBinderException($"External process exited with non-zero exit code: {process.ExitCode}");
            }
        }
        catch (Exception)
        {
            throw;
        }

        // ReadToEndã¯æœ€å¾Œã®æ”¹è¡Œæ–‡å­—ã¾ã§å–å¾—ã™ã‚‹ã®ã§æœ«å°¾ã‚’å‰Šé™¤
        string uid = uidln[..^1];

        // uid ãŒ0ã¨ã„ã†ã“ã¨ã¯rootãƒ¦ãƒ¼ã‚¶ãƒ¼ã€‚
        if ("0".Equals(uid))
        {
            judge = true;
        }
#else
        AppDomain domain = Thread.GetDomain();

        domain.SetPrincipalPolicy(PrincipalPolicy.WindowsPrincipal);
        WindowsPrincipal principal = (WindowsPrincipal?)Thread.CurrentPrincipal ?? throw new NullReferenceException();

        judge = principal.IsInRole(WindowsBuiltInRole.Administrator);
#endif
        return judge;
    }

    private static void Main(string[] args)
    {
        bool judge = false;
        try
        {
           judge = IsAdministrator(); 
        } catch (Exception e)
        {
            Console.WriteLine(e.ToString());
            return;
        }

        if (judge)
        {
            Console.WriteLine("You are Administrator user!");
        } else {
            Console.WriteLine("You are not Administrator user!");
        }
    }
}
```


## ã¾ã¨ã‚

windowsã¨unixç’°å¢ƒä¸¡æ–¹ã§ã‚‚å‹•ãã‚‚ã®ãŒå¿…è¦ãªã‚‰ã²ãŸã™ã‚‰ã“ã®ã‚ˆã†ã«ifãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã§Unix, windows
ã¨ç’°å¢ƒã‚’åˆ†ã‘ã¦æ›¸ãã“ã¨ã«ãªã‚‹ã€‚æ„å¤–ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§ã¯è‰¯ã„ã€‚

å¿…è¦ã¨ã‚ã‚‰ã°ã“ã“ã‹ã‚‰runtimeã”ã¨ã«ã•ã‚‰ã«ifãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã§åˆ†ã‘ã‚‹ã“ã¨ã«ãªã‚‹ã€‚

.netframeworkç³»ã¨dotnet coreç³»ã‚’runtimeã§åˆ†ã‘ã‚‹å ´åˆã¯ã»ã¼ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒå€ã«ãªã‚‹ã“ã¨ã¯è¦šæ‚Ÿã—ã‚ˆã†ã€‚

## å‚è€ƒ

[WindowsPrincipal class](https://learn.microsoft.com/ja-jp/dotnet/api/system.security.principal.windowsprincipal?view=net-7.0)

[WindowsBuiltinRole Enum](https://learn.microsoft.com/ja-jp/dotnet/api/system.security.principal.windowsbuiltinrole?view=net-7.0)
