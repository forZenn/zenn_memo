---
title: "rhel系OSのbootstrap"
emoji: "💬"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ['Linux', 'Fedora', 'ArchLinux', 'bash']
published: true
---

debian系にはdebootstrap,arcn系はarch-bootstrapで、
bootstrap(最小限のインストールやchroot環境用の初期化処理)を行うことができる。

rhel系OSにはこれらと=のものはないが、dnfコマンドでbootstrap作業を行うことができる。

dnfコマンドはrhel系OSでは最初からインストールされており、その他archlinux,manjarolinuxでは
Community repositoryにコマンドがあるので、それをインストールすることで、使うことができる。

例として、chroot環境に対するインストール方法をここに書きます。
最小限のインストールを行いたいときや、ホスト側のスペックが貧弱なときの仮想環境として、
良いと思います。

## 前提

ホスト側がdnfをインストールできるOSであること。
最近ではrhel系以外のDebian系、arch系、Gentooでも
特に何もしなくてもOS標準のパッケージライブラリでインストールできる。

rhel系以外はdnfをインストールしても、
/etc/yum.repos.dディレクトリが作成されていないので、
手動で作成すること。

## 下準備

以下の構成にしておくこと。

### ゲスト側の準備

あらかじめ下のようにパーティションを分けておき、
そこにインストールしていきます。

#### chrootを使う場合

```bash
# 仮想環境用のパーティションを作っておき、フォーマット
mkfs.ext4 /dev/sdxn
# デバイスファイルをマウント。ここにdnfでインストールする
mount /dev/sdxn /mnt/fedora
```

#### systemd-nspawnを使う場合

```bash
# debian系
sudo apt install -y systemd-container
```

仮想環境用のディレクトリ作成

```bash
sudo mkdir /var/lib/machines/fedora
```

### レポジトリの設定

ホスト側のOSがmanjaro,archlinuxの場合はdnfをインストールしただけでは、dnfコマンドが使えないので下記の設定をしておくこと。
centos, oracle linuxはバージョンによって微妙にパスが違うので注意

#### fedoraをインストールしたい場合

```bash:/etc/yum.repos.d/fedora.repo
[fedora]
name=Fedora Server $releasever - Base
baseurl=http://ftp.riken.jp/pub/Linux/fedora/releases/$releasever/Server/$basearch/os
gpgkey=https://getfedora.org/static/fedora.gpg
```

#### centos-streamをインストールしたい場合

##### centos-stream 8

```bash:/etc/yum.repos.d/centos.repo
[centos]
name=CentOS-stream $releasever - Base
baseurl=http://ftp.riken.jp/pub/Linux/centos/$releasever-stream/BaseOS/$basearch/os
gpgkey=http://ftp.riken.jp/pub/Linux/centos/RPM-GPG-KEY-CentOS-Official
```

##### centos-stream 9

```bash:/etc/yum.repos.d/centos.repo
[centos]
name=CentOS-stream $releasever - Base
baseurl=http://ftp.riken.jp/pub/Linux/centos-stream/$releasever-stream/BaseOS/$basearch/os
gpgkey=http://ftp.riken.jp/pub/Linux/centos/RPM-GPG-KEY-CentOS-Official
```

##### oracle-linuxをインストールしたい場合

##### oracle-linux8 または9

```bash:/etc/yum.repos.d/oracle_linux.repo
[oracle_linux]
name=oracle_linux $releasever - Base
baseurl=https://yum.oracle.com/repo/OracleLinux/OL$releasever/baseos/latest/$basearch/
gpgkey=https://yum.oracle.com/RPM-GPG-KEY-oracle-ol$releasever
```

##### oracle-linux7

```bash:/etc/yum.repos.d/oracle_linux.repo
[oracle_linux]
name=oracle_linux $releasever - Base
baseurl=https://yum.oracle.com/repo/OracleLinux/OL$releasever/latest/$basearch/
gpgkey=https://yum.oracle.com/RPM-GPG-KEY-oracle-ol$releasever
```

## ホストから仮想環境へパッケージのインストール

下記のようにコマンドを叩くとディレクトリにインストールされます。

rhel系は最小インストールするとvimどころかviも入っていないし、
passwdも入っていないため、仮想環境に入った後の作業でつまずきます。
必ず、vimとpasswdは入れましょう。

名前解決にはsystemd-resolvedを使いましょう。
resolvectlが強力なのとsystemd-nspawnを使う場合は
できるだけ、systemdに機能を寄せた方が管理が楽です。

ネットワークの管理については
fedoraはsystemd-networkdをインストールして使ってください。

centos, oracle-linuxもsystemd-networkdを使いたいんですが、
ちょっと[トラブル中みたい](https://bugzilla.redhat.com/show_bug.cgi?id=2020254)なので、しばらくはNetworkManagerですね...バージョン８では、入ることはなく、9以降入るかどうか...NetworkManagerよりsystemd-networkdの方がスジがよく、
いい意味で小さい作りになっているのでのちに期待しましょう。

### fedoraをインストールしたい場合

```bash
ARCH=amd64
version=35
# repoにyum.repoに設定したレポジトリ名（例[fedora]）を使う。
dnf install --installroot=/mnt/fedora --repo=fedora --releasever=$version fedora-release-server systemd dnf passwd vim systemd-networkd systemd-resolved
```

### centos-streamをインストールしたい場合

```bash
ARCH=amd64
version=8
# repoにyum.repoに設定したレポジトリ名（例[centos]）を使う。
dnf install --installroot=/mnt/centos --repo=centos --releasever=$version centos-stream-release systemd dnf passwd vim-minimal vim-filesystem NetworkManager systemd-resolved
```

### oracle-linuxをインストールしたい場合


#### oracle linux 8, 9の場合

```bash1
ARCH=x86_64
version=8
# repoにyum.repoに設定したレポジトリ名（例[oracle_linux]）を使う。
dnf install --installroot=/mnt/oracle_linux --repo=oracle_linux --releasever=$version oraclelinux-release-el${version} systemd dnf passwd vim-minimal vim-filesystem NetworkManager systemd-resolved
```

#### oracle linux 7の場合

```bash
ARCH=x86_64
version=8
# repoにyum.repoに設定したレポジトリ名（例[oracle_linux]）を使う。
# dnf が無いので変わりにyumをインストールする。
# またosを起動させるのに必要なファイルとしてrootfilesというパッケージも必要になる。
# dbusも自動で入らないので追加する必要がある。

dnf install --installroot=/mnt/oracle_linux --repo=oracle_linux --releasever=$version oraclelinux-release-el${version} systemd yum rootfiles dbus passwd vim-minimal vim-filesystem NetworkManager systemd-resolved
```

oracle linux7は/etc/os-releaseを手動で書いているor linux imageをインストールしないと書き込まないっぽいのでファイルとして追加する。
/etc/os-releaseが無いとmachinectlはosでないと判断するため。必須。
仮想環下で。

```bash:/etc/os-release
NAME="Oracle Linux Server"
VERSION="7.9"
ID="ol"
ID_LIKE="fedora"
VARIANT="Server"
VARIANT_ID="server"
VERSION_ID="7.9"
PRETTY_NAME="Oracle Linux Server 7.9"
ANSI_COLOR="0;31"
CPE_NAME="cpe:/o:oracle:linux:7:9:server"
HOME_URL="https://linux.oracle.com/"
BUG_REPORT_URL="https://bugzilla.oracle.com/"

ORACLE_BUGZILLA_PRODUCT="Oracle Linux 7"
ORACLE_BUGZILLA_PRODUCT_VERSION=7.9
ORACLE_SUPPORT_PRODUCT="Oracle Linux"
ORACLE_SUPPORT_PRODUCT_VERSION=7.9
```

必須でないはずだが、一応、/etc/oracle-releaseも追加しておく。

```bash:/etc/oracle-release
Oracle Linux Server release 7.9
```

yumはGPGの解決までしないので。gpgの鍵を手動でインストールする必要がある。

```bash
# 鍵用のディレクトリ作成
# 仮想環境へのパス
mkdir /mnt/oracle_linux/etc/pki/rpm-gpg
wget http://public-yum.oracle.com/RPM-GPG-KEY-oracle-ol7 -O /mnt/oracle_linux/etc/pki/rpm-gpg/RPM-GPG-KEY-oracle
```

#### その他必要なパッケージ

xargsやless, pingは必須級だと思うのでインストールしておきましょう。

```bash
dnf install -y findutils less iputils mlocate
```

## 名前解決

外からvimで/var/lib/machines/machinename/etc/systemd/resolv.confを編集してください。
外からだとホストの設定を参考したりコピペできるので楽だと思います。
DNSの設定だけするなら
DNS=8.8.8.8とするとよい。

## 仮想環境内でdnfのコマンドを実行すると--releaseverをつけろと言われる場合

systemd-nspawnを使っていて仮想環境に入ると、os-releaseからうまく値を
取得できないのか、仮想マシンのdnfコマンドでエラーがでます。

--releasever 8 のようにバージョンを指定するか
あらかじめ/etc/yum.d//etc/yum.repos.d/*.repoに書かれている$releaseverの値を実際の値に上書きしてください。

下のスクリプトで一括で変更できます。

```bash
# fedora 36を使っている場合
ls -1 /var/lib/machines/fedora/etc/yum.repos.d/ | xargs -I {} sed -i 's/\$releasever/36/g' /var/lib/machines/fedora/etc/yum.repos.d/{}
```

## まとめ

あとはchrootか、systemd-nspawnでそれぞれの環境に入り、Linux imageやfirmwareをインストールしたり、osの設定を行ってください。

oracle 21cのインストールの資料を見てもoracle linux7が例に使われているし、
oracle配布のdocker containerもoracle linux7が使われているので、
DB用途で使う場合はまだしばらくはoracle linux7を使うことになると思います。
