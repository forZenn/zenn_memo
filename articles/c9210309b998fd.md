---
title: "rhel系OSのbootstrap"
emoji: "💬"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ['Linux', 'Fedora', 'ArchLinux', 'bash']
published: true
---

debian系にはdebootstrap,arcn系はarch-bootstrapで、
bootstrap(最小限のインストールやchroot環境用の初期化処理)を行うことができる。

rhel系OSにはこれらと=のものはないが、dnfコマンドでbootstrap作業を行うことができる。

dnfコマンドはrhel系OSでは最初からインストールされており、その他archlinux,manjarolinuxでは
Community repositoryにコマンドがあるので、それをインストールすることで、使うことができる。

例として、chroot環境に対するインストール方法をここに書きます。
最小限のインストールを行いたいときや、ホスト側のスペックが貧弱なときの仮想環境として、
良いと思います。

## 前提

ホスト側がdnfをインストールできるOSであること。
最近ではrhel系以外のDebian系、arch系、Gentooでも
特に何もしなくてもOS標準のパッケージライブラリでインストールできる。

rhel系以外はdnfをインストールしても、
/etc/yum.repos.dディレクトリが作成されていないので、
手動で作成すること。

## 下準備

以下の構成にしておくこと。

### ゲスト側の準備

あらかじめ下のようにパーティションを分けておき、
そこにインストールしていきます。

#### chrootを使う場合

```bash
# 仮想環境用のパーティションを作っておき、フォーマット
mkfs.ext4 /dev/sdxn
# デバイスファイルをマウント。ここにdnfでインストールする
mount /dev/sdxn /mnt/fedora
```

#### systemd-nspawnを使う場合

```bash
# debian系
sudo apt install -y systemd-container
```

仮想環境用のディレクトリ作成

```bash
sudo mkdir /var/lib/machines/fedora
```

### レポジトリの設定

ホスト側のOSがmanjaro,archlinuxの場合はdnfをインストールしただけでは、dnfコマンドが使えないので下記の設定をしておくこと。

fedoraをインストールしたい場合。

```bash:/etc/yum.repos.d/fedora.repo
[fedora]
name=Fedora Server $releasever - Base
baseurl=http://ftp.riken.jp/pub/Linux/fedora/releases/$releasever/Server/$basearch/os
gpgkey=https://getfedora.org/static/fedora.gpg
```

centos-streamをインストールしたい場合

```bash:/etc/yum.repos.d/centos.repo
[centos]
name=CentOS-stream $releasever - Base
baseurl=http://ftp.riken.jp/pub/Linux/centos/$releasever-stream/BaseOS/$basearch/os
gpgkey=http://ftp.riken.jp/pub/Linux/centos/RPM-GPG-KEY-CentOS-Official
```

oracle-linuxをインストールしたい場合

```bash:/etc/yum.repos.d/oracle_linux.repo
[oracle_linux]
name=oracle_linux $releasever - Base
baseurl=https://yum.oracle.com/repo/OracleLinux/OL$releasever/baseos/latest/$basearch/
gpgkey=https://yum.oracle.com/RPM-GPG-KEY-oracle-ol$releasever
```

## 使い方

下記のようにコマンドを叩くとディレクトリにインストールされます。

fedoraをインストールしたい場合。

```bash
ARCH=amd64
version=35
# repoにyum.repoに設定したレポジトリ名（例[fedora]）を使う。
dnf install --installroot=/mnt/fedora --repo fedora --releasever=$version fedora-release-server systemd dnf
```

centos-streamをインストールしたい場合

```bash
ARCH=amd64
version=8
# repoにyum.repoに設定したレポジトリ名（例[centos]）を使う。
dnf install --installroot=/mnt/centos --repo=centos --releasever=$version centos-stream-release systemd dnf 
```

oracle-linuxをインストールしたい場合

```bash
ARCH=x86_64
version=8
# repoにyum.repoに設定したレポジトリ名（例[oracle_linux]）を使う。
## oracle linux 7,8の場合
dnf install --installroot=/mnt/oracle_linux --repo=oracle_linux --releasever=$version oracle-release-el${version} systemd dnf

## oracle linux 9の場合。coreなパッケージ名が変更になったので、変更。
dnf install --installroot=/mnt/oracle_linux --repo=oracle_linux --releasever=$version oraclelinux-release-el${version} systemd dnf
```

あとはchrootか、systemd-nspawnでそれぞれの環境に入り、Linux imageやfirmwareをインストールしたり、osの設定を行ってください。
