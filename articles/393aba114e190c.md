---
title: "doasでrm -rf * やrm -rf /* を防ぐ"
emoji: "😎"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["doas", "openbsd", "bsd", "linux"]
published: true
published_at: 2023-08-09 19:00 
---

たまたま下のようなスレッドを見つけた。

@[tweet](https://twitter.com/t_yano/status/1688831995361796096)

これについて、手厳しい意見（怒る側も責任ある以上仕方ないが）もあったが、技術的に解決できるのではないかと
思ったので、運用について安全に倒した解決方を書く。

## 前提条件

**動作のチェックは必ず、仮装環境で行いましょう。非常に危険です。私が書いたものを信用せずに必ず仮装環境で調べてから本番でチェックしてください。私がバグを作っている事前提でちゃんとチェックすること。**

安全に運用する運用ルールとして次のルールを設けます。

**削除はスクリプトにせよ、即時にせよ削除用のgroupでdoasコマンドからのみ削除する。**

つまり削除するときは運用上、必ず下のようなコマンドを叩くことになります。

```bash
doas rm you-wan-to-delete
```

ここでは**削除用のグループdeleterにのみファイルやディレクトリを削除できる。そして、rmに複数のフォルダを指定することは無い。必要な場合はフォルダの数だけrmを書く**という運用だと仮定します。

ここでは簡単のため**root含めてすべてのユーザーがdeleterグループに属している**として先に進んでください。
この設定は**ユーザーの作成時に属するグループを指定できるので本番でも容易な設定なはず**です。

引数の文字列が完全一致かつ同じ順序のみ条件に引っ掛かるので末尾の/があるか無いかのパターンや-r -fと一緒になっているパターン両方書く必要があります。気をつけましょう。
半角スペースは無視できます。

## グループ作成

```bash
# グループ作成
sudo groupadd deleter

## 既存のユーザーをグループに追加。<user>を適当なユーザーとして実行してください。
sudo usermod -aG deleter <user>
```

## 設定ファイル

```bash:/etc/doas.conf
# 最初に許されるパターンを書く。
permit nopass :deleter cmd rm 
# rm で危険なパターンを全て書く。
deny          :deleter cmd rm args -rf     *
deny          :deleter cmd rm args -fr     *
deny          :deleter cmd rm args -r -f   *
deny          :deleter cmd rm args -f -r   *
deny          :deleter cmd rm args -rf     ./
deny          :deleter cmd rm args -fr     ./
deny          :deleter cmd rm args -r -f   ./
deny          :deleter cmd rm args -f -r   ./
deny          :deleter cmd rm args -rf     ./*
deny          :deleter cmd rm args -fr     ./*
deny          :deleter cmd rm args -r -f   ./*
deny          :deleter cmd rm args -f -r   ./*
deny          :deleter cmd rm args -rf     ./*/
deny          :deleter cmd rm args -fr     ./*/
deny          :deleter cmd rm args -r -f   ./*/
deny          :deleter cmd rm args -f -r   ./*/
deny          :deleter cmd rm args -rf     /*
deny          :deleter cmd rm args -fr     /*
deny          :deleter cmd rm args -r -f   /*
deny          :deleter cmd rm args -f -r   /*
deny          :deleter cmd rm args -rf     /*/
deny          :deleter cmd rm args -fr     /*/
deny          :deleter cmd rm args -f -r   /*/
deny          :deleter cmd rm args -r -f   /*/
```

## 適当な値でチェック

存在しない変数なり、なんなりでチェックしてみてください。
展開後の値をdoasは参照するので、削除されることはないはずです

```bash
# abcは存在しない変数
doas rm -rf ${abc}*
doas rm -rf ./${abc}*
```

## まとめ

他にrmやらその他削除周りで危険な処理があれば、doas.confに追加したら完全に防げます。
bsdの処理は詳しくないので、もっと楽にできる、違うなど私が見落としている可能性もあるのでその場合はOpenBSDのユーザーが突っ込んでください。
ただ、これでも危険なパターンをすり抜ける可能性もあるので、手順書やコミュニケーションでの連携は必要です。
