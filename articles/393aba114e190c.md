---
title: "doasã§rm -rf * ã‚„rm -rf /* ã‚’é˜²ã"
emoji: "ğŸ˜"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["doas", "openbsd", "bsd", "linux"]
published: false
---

ãŸã¾ãŸã¾ä¸‹ã®ã‚ˆã†ãªã‚¹ãƒ¬ãƒƒãƒ‰ã‚’è¦‹ã¤ã‘ãŸã€‚

@[tweet](https://twitter.com/t_yano/status/1688831995361796096)

ã“ã‚Œã«ã¤ã„ã¦ã€æ‰‹å³ã—ã„æ„è¦‹ï¼ˆæ€’ã‚‹å´ã‚‚è²¬ä»»ã‚ã‚‹ä»¥ä¸Šä»•æ–¹ãªã„ãŒï¼‰ã‚‚ã‚ã£ãŸãŒã€æŠ€è¡“çš„ã«è§£æ±ºã§ãã‚‹ã®ã§ã¯ãªã„ã‹ã¨
æ€ã£ãŸã®ã§ã€é‹ç”¨ã«ã¤ã„ã¦å®‰å…¨ã«å€’ã—ãŸè§£æ±ºæ–¹ã‚’æ›¸ãã€‚

ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰å®Ÿè¡Œã§ã‚‚ã€å¯¾è©±å½¢å¼ã§å®Ÿè¡Œã§ã‚‚é˜²ã’ã‚‹ã€‚

## å‰ææ¡ä»¶

**å‹•ä½œã®ãƒã‚§ãƒƒã‚¯ã¯å¿…ãšã€ä»®è£…ç’°å¢ƒã§è¡Œã„ã¾ã—ã‚‡ã†ã€‚éå¸¸ã«å±é™ºã§ã™ã€‚ç§ãŒæ›¸ã„ãŸã‚‚ã®ã‚’ä¿¡ç”¨ã›ãšã«å¿…ãšä»®è£…ç’°å¢ƒã§èª¿ã¹ã¦ã‹ã‚‰æœ¬ç•ªã§ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚ç§ãŒãƒã‚°ã‚’ä½œã£ã¦ã„ã‚‹äº‹å‰æã§ã¡ã‚ƒã‚“ã¨ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ã€‚**

å®‰å…¨ã«é‹ç”¨ã™ã‚‹é‹ç”¨ãƒ«ãƒ¼ãƒ«ã¨ã—ã¦æ¬¡ã®ãƒ«ãƒ¼ãƒ«ã‚’è¨­ã‘ã¾ã™ã€‚

**å‰Šé™¤ã¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã›ã‚ˆã€å³æ™‚ã«ã›ã‚ˆå‰Šé™¤ç”¨ã®groupã§doasã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰ã®ã¿å‰Šé™¤ã™ã‚‹ã€‚**

ã¤ã¾ã‚Šå‰Šé™¤ã™ã‚‹ã¨ãã¯é‹ç”¨ä¸Šã€å¿…ãšä¸‹ã®ã‚ˆã†ãªdoasã«rmã‚³ãƒãƒ³ãƒ‰ã¨ãã®å¼•æ•°ã‚’æ¸¡ã—ã¦å®Ÿè¡Œã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

```bash
doas rm you-wan-to-delete
```

ã“ã“ã§ã¯**å‰Šé™¤ç”¨ã®ã‚°ãƒ«ãƒ¼ãƒ—deleterã«ã®ã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤ã§ãã‚‹ã€‚ãã—ã¦ã€rmã«è¤‡æ•°ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã¯ç„¡ã„ã€‚å¿…è¦ãªå ´åˆã¯ãƒ•ã‚©ãƒ«ãƒ€ã®æ•°ã ã‘rmã‚’æ›¸ã**ã¨ã„ã†é‹ç”¨ã ã¨ä»®å®šã—ã¾ã™ã€‚

ã“ã“ã§ã¯ç°¡å˜ã®ãŸã‚**rootå«ã‚ã¦ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒdeleterã‚°ãƒ«ãƒ¼ãƒ—ã«å±ã—ã¦ã„ã‚‹**ã¨ã—ã¦å…ˆã«é€²ã‚“ã§ãã ã•ã„ã€‚
ã“ã®è¨­å®šã¯**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆæ™‚ã«å±ã™ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æŒ‡å®šã§ãã‚‹ã®ã§æœ¬ç•ªã§ã‚‚å®¹æ˜“ãªè¨­å®šãªã¯ãš**ã§ã™ã€‚

å¼•æ•°ã®æ–‡å­—åˆ—ãŒå®Œå…¨ä¸€è‡´ã‹ã¤åŒã˜é †åºã®ã¿æ¡ä»¶ã«å¼•ã£æ›ã‹ã‚‹ã®ã§æœ«å°¾ã®/ãŒã‚ã‚‹ã‹ç„¡ã„ã‹ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚„-r -fã¨ä¸€ç·’ã«ãªã£ã¦ã„ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ä¸¡æ–¹æ›¸ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚æ°—ã‚’ã¤ã‘ã¾ã—ã‚‡ã†ã€‚
åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ã¯ç„¡è¦–ã§ãã¾ã™ã€‚

## ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ

```bash
# ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ
sudo groupadd deleter

## æ—¢å­˜ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ ã€‚<user>ã‚’é©å½“ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
sudo usermod -aG deleter <user>
```

## è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

doasã§è¨±å¯ã•ã‚Œã‚‹ã‹ã©ã†ã‹åˆ¤å®šã•ã‚Œã¦ã‹ã‚‰ã€å®Ÿè¡Œã•ã‚Œã‚‹ã®ã§

è¨±å¯ã•ã‚Œã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å¿…è¦ã«å¿œã˜ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¦ãã ã•ã„ã€‚

ãƒ€ãƒ¡ãªä¾‹ã€‚
doasã«æ¸¡ã•ã‚Œã‚‹å‰ã«\*ãŒå±•é–‹ã•ã‚Œã¦ã€Downloads, Desktopã¿ãŸã„ãªå€¤ã«
ãªã‚‹ãŸã‚ã€\*ã‚’ä½¿ã£ã¦çµã‚‹ã“ã¨ã¯ã§ããªã„ã€‚
ä¸‹ã®ä¾‹ã ã¨rm \*ã‚„rm ./\*ã¯é˜²ã’ãªã„ã¨ã„ã†ã“ã¨ã€‚
ã“ã‚Œã¯çµå±€ã®ã¨ã“ã‚rmã®å±é™ºãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç¦æ­¢ã§ããªã„ã®ã§ã€ã‚ˆããªã„ã€‚

```bash:/etc/doas.conf
# æœ€åˆã«è¨±ã•ã‚Œã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ›¸ãã€‚
# å±é™ºãªãƒ‘ã‚¿ãƒ¼ãƒ³ä»¥å¤–å…¨ã¦è¨±ã™ãªã‚‰ä¸‹ã®ã‚ˆã†ã«æ›¸ãã€‚
# permit nopass :deleter cmd rm 



# rm ã§å±é™ºãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å…¨ã¦æ›¸ãã€‚
deny          :deleter cmd rm args         *
deny          :deleter cmd rm args -r      *
deny          :deleter cmd rm args -f      *
deny          :deleter cmd rm args -rf     *
deny          :deleter cmd rm args -fr     *
deny          :deleter cmd rm args -r -f   *
deny          :deleter cmd rm args -f -r   *
deny          :deleter cmd rm args         ./
deny          :deleter cmd rm args -r      ./
deny          :deleter cmd rm args -f      ./
deny          :deleter cmd rm args -rf     ./
deny          :deleter cmd rm args -fr     ./
deny          :deleter cmd rm args -r -f   ./
deny          :deleter cmd rm args -f -r   ./
deny          :deleter cmd rm args         ./*
deny          :deleter cmd rm args -r      ./*
deny          :deleter cmd rm args -f      ./*
deny          :deleter cmd rm args -rf     ./*
deny          :deleter cmd rm args -fr     ./*
deny          :deleter cmd rm args -r -f   ./*
deny          :deleter cmd rm args -f -r   ./*
deny          :deleter cmd rm args         ./*/
deny          :deleter cmd rm args -r      ./*/
deny          :deleter cmd rm args -f      ./*/
deny          :deleter cmd rm args -rf     ./*/
deny          :deleter cmd rm args -fr     ./*/
deny          :deleter cmd rm args -r -f   ./*/
deny          :deleter cmd rm args -f -r   ./*/
deny          :deleter cmd rm args         /
deny          :deleter cmd rm args -r      /
deny          :deleter cmd rm args -f      /
deny          :deleter cmd rm args -rf     /
deny          :deleter cmd rm args -fr     /
deny          :deleter cmd rm args -r -f   /
deny          :deleter cmd rm args -f -r   /
deny          :deleter cmd rm args         /*
deny          :deleter cmd rm args -r      /*
deny          :deleter cmd rm args -f      /*
deny          :deleter cmd rm args -rf     /*
deny          :deleter cmd rm args -fr     /*
deny          :deleter cmd rm args -r -f   /*
deny          :deleter cmd rm args -f -r   /*
deny          :deleter cmd rm args         /*/
deny          :deleter cmd rm args -r      /*/
deny          :deleter cmd rm args -f      /*/
deny          :deleter cmd rm args -rf     /*/
deny          :deleter cmd rm args -fr     /*/
deny          :deleter cmd rm args -f -r   /*/
deny          :deleter cmd rm args -r -f   /*/
```

### ã§ã¯ã©ã†ã™ã‚‹ã‹ï¼Ÿ

ä¸€éƒ¨ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã¿rmã‚’è¨±ã™ã‚ˆã†ã«æ›¸ãã€‚

```bash:/etc/doas.conf
# ä¸€éƒ¨ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã¿è¨±ã™ãªã‚‰ä¸‹ã®ã‚ˆã†ã«æ›¸ã„ã¦ã„ãã€‚
# å¼•æ•°ã®çµ„ã¿åˆã‚ã›å«ã‚ã¦å®Œå…¨ä¸€è‡´ã§ãªã„ã¨è¨±ã•ã‚Œãªã„ã®ã§æ³¨æ„ã€‚
permit nopass :deleter cmd rm args -rf /data/2018/01 
```

## é©å½“ãªå€¤ã§ãƒã‚§ãƒƒã‚¯

å­˜åœ¨ã—ãªã„å¤‰æ•°ãªã‚Šã€ãªã‚“ãªã‚Šã§ãƒã‚§ãƒƒã‚¯ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
å±•é–‹å¾Œã®å€¤ã‚’doasã¯å‚ç…§ã™ã‚‹ã®ã§ã€å‰Šé™¤ã•ã‚Œã‚‹ã“ã¨ã¯ãªã„ã¯ãšã§ã™

```bash
# abcã¯å­˜åœ¨ã—ãªã„å¤‰æ•°
doas rm -rf ${abc}*
doas rm -rf ./${abc}*
```

## ã¾ã¨ã‚

ä»–ã«rmã‚„ã‚‰ãã®ä»–å‰Šé™¤å‘¨ã‚Šã§å±é™ºãªå‡¦ç†ãŒã‚ã‚Œã°ã€doas.confã«è¿½åŠ ã—ãŸã‚‰å®Œå…¨ã«é˜²ã’ã¾ã™ã€‚
bsdã®å‡¦ç†ã¯è©³ã—ããªã„ã®ã§ã€ã‚‚ã£ã¨æ¥½ã«ã§ãã‚‹ã€é•ã†ãªã©ç§ãŒè¦‹è½ã¨ã—ã¦ã„ã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚‹ã®ã§ãã®å ´åˆã¯OpenBSDã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒçªã£è¾¼ã‚“ã§ãã ã•ã„ã€‚
ãŸã ã€ã“ã‚Œã§ã‚‚å±é™ºãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ã™ã‚ŠæŠœã‘ã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚‹ã®ã§ã€æ‰‹é †æ›¸ã‚„ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã®é€£æºã‚„å¤‰æ•°ãŒç©ºã§ãªã„ã‹ã®ãƒã‚§ãƒƒã‚¯ã¯å¿…é ˆã§ã™ã€‚

æ„šç›´ã«ã‚„ã‚ã†ã¨ã™ã‚‹ã¨ç°¡å˜ã«doas.confãŒã¶ãã¶ãã«è†¨ã‚Œä¸ŠãŒã‚‹ã®ãƒã‚¸ã§è€ƒãˆã‚‚ã®ã ãªã...
