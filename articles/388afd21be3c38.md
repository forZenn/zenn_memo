---
title: "rsyncã‚’ä½¿ã£ãŸãƒ•ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—"
emoji: "ðŸ“š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Linux", "bash", "Gentoo"]
published: true
---

ä»Šæ›´rsysncã§æ‰‹å‹•ã§å–ã‚‹ã®ã¯ã©ã†ã‹ï¼Ÿã¨ã„ã†å£°ã‚‚ã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚
ç¢ºã‹ã«timeshiftã¨ã„ã†æ–‡æ˜Žã®åˆ©å™¨ã‚„ã€baculaã®ã‚ˆã†ãªé«˜åº¦ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚µãƒ¼ãƒãƒ¼ã‚‚ã‚ã‚Šã¾ã™ã—ã€
vpsã§ã‚‚ã‚µãƒ¼ãƒãƒ¼ã®ãƒ•ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ç°¡å˜ã«ã—ã‹ã‚‚å®‰ä¾¡ã«å–ã‚Œã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚‚ã‚ã‚Šã¾ã™ã€‚

ã—ã‹ã—ã€timeshiftã¯ã©ã¡ã‚‰ã‹ã¨ã„ã†ã¨ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å–ã‚‹ã®ãŒä»•äº‹ã§ã€
/homeã€/rootä»¥ä¸‹ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯éžæŽ¨å¥¨ãªã®ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼é…ä¸‹ã¯rsyncã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã‚‹ã“ã¨ã«ãªã£ãŸã‚Šã€Gentooã ã¨timeshiftãŒã¾ã testingãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ä½¿ã„ã¥ã‚‰ã„ãªã©ã®æ¬ ç‚¹ãŒã‚ã‚Šã€

baculaã ã¨å€‹äººã€å°è¦æ¨¡ã€ä¸­ã®å°è¦æ¨¡ç¨‹åº¦ã¾ã§ãªã‚‰ã‚„ã‚ŠéŽãŽã§ç®¡ç†ã‚³ã‚¹ãƒˆã®ã»ã†ãŒé«˜ãã†

ãªã©å¸¯ã«çŸ­ã—ã€ãŸã™ãã«é•·ã—ã¨ã„ã†çŠ¶æ³ã ã£ãŸã‚Šã—ã¾ã™ã€‚

ã‚¼ãƒ­ã‹ã‚‰è‡ªåˆ†ã§ãƒ•ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—,å·®åˆ†ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã®ã¯
ãã“ãã“å¤§å¤‰ã‹ã¤ã€ã‚¹ã‚­ãƒ«ãŒå¿…è¦ã«ãªã‚‹ã®ã§ã“ã“ã«æ›¸ãã¾ã™ã€‚
å¿…è¦ã«å¿œã˜ã¦ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚

## ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

```bash:system_backup.sh
#!/bin/bash
#
# gnu command util.

#######################################
# write stderr syntax. google style(https://google.github.io/styleguide/shellguide.html)
# Globals:
#   BACKUP_FORMAT
#   BACKUP_DESTINATION
# Arguments:
#   All.
# Outputs:
#   format 
# Returns:
#   0 if thing was backup is successed, non-zero on error.
# Example:
#   # .cache/ directory has browser cache file. chrome, edge and more...
#   # --defferental å·®åˆ†ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
#   system_backup --diffrental --backup-dest /run/media/${USER}/data --add-exclude $HOME/.cache
#######################################
function system_backup() {

  source $(dirname $0)/../function/gnu_alias
  if ! gnu_alias; then
    return 1;
  fi

  if [ ${UID} -ne "0" ] && [ ${EUID} -ne "0" ]; then
    echo 'this function use superuser only' >&2
    return 1
  fi

  # å¼•æ•°ã‚’ãƒ‘ãƒ¼ã‚¹ã—ãŸã¨ãã®ã‚µãƒ–ã‚·ã‚§ãƒ«ã®çµæžœå–å¾—
  local tmp_file=$(mktemp)
  echo 0 > $tmp_file
  trap "
    rm $tmp_file
    trap - RETURN
  " RETURN
  local options=$(getopt -o f: -l dry-run,backup-dest:,diffrental,check-exclude,system-only,add-exclude: -- "$@" || echo 1 > $tmp_file)
  local re=$(sed -n '1p' $tmp_file)

  if [ "$re" -ne "0" ]; then
    return $re
  fi
  
  local backup_format
  local dryrun
  local backup_destination
  local check_exclude=1
  local add_exclude
  local system_only=1
  # ãƒ‘ãƒ¼ã‚¹ã—ãŸå€¤ã‚’æ¸¡ã™
  eval set -- "$options"

  # å€¤ã®ã‚»ãƒƒãƒˆã®ã¿è¡Œã†
  while [ $# -gt 0 ]; do
    case $1 in
      -f)
        shift
        backup_format=$1
        ;;
      --check-exclude)
        shift
        check_exclude=0
        ;;
      --dry-run)
        shift
        dryrun='--dry-run'
        ;;
      --system-only)
        shift
        system_only=0
        ;;
      --add-exclude)
        shift
        add_exclude=$1
        ;;
      --backup-dest)
        shift
        backup_destination=$1
        ;;

      --diffrental)
        shift
        diffrental=0
        ;;
        
      --)
        shift
        break
        ;;
      *)
        shift
        ;;
    esac
  done

  # backupã®ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã‹ã£ãŸã‚‰ã€ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã™ã‚‹ã€‚ãã‚Œã§ã‚‚ãªã‹ã£ãŸã‚‰ã€
  if [ -z $backup_format ]; then
    backup_format=$BACKUP_FORMAT
    if [ -z $backup_format ]; then
      backup_format="%Y%m%dT%H%M%S%Z"
    fi
  fi

  local suffix_format=$(date +"${backup_format}")

  local exclude_list=("dev" "proc" "sys" "tmp" "run" "mnt" "media" "lost+found")
  
  exclude_list+=($(echo /home/*/.cache | sed 's|^/||'))
  exclude_list+=($(echo /root/.cache | sed 's|^/||' ))

  # é™¤å¤–ãƒªã‚¹ãƒˆã¸ã®è¿½åŠ 
  if [ ! -z $add_exclude ]; then
    # destination 
    exclude_list+=($(
      echo $add_exclude | \
        sed 's/,/ /g' | \
        xargs -n 1 | \
        sed 's|/$||' | \
        sed 's|^/||' | \
        xargs
      )
    )
  fi

  # system only exclude user directory.
  if [ "$system_only" -eq "0" ]; then
    exclude_list+=($(echo /home | sed 's|^/||' ))
    exclude_list+=($(echo /root | sed 's|^/||' ))
  fi
  # output exclude directory
  if [ "$check_exclude" -eq "0" ]; then
    echo "${exclude_list[@]}"
    return
  fi

  if [ -z $backup_destination ]; then
    backup_destination=$BACKUP_DESTINATION
    if [ -z $backup_destination ]; then
      echo 'set backup destination.' >&2
      return 1
    fi
  fi
  # æœ«å°¾ã®/ã‚’å‰Šé™¤ã—ã¦ãŠãã€‚
  backup_destination=$(echo $backup_destination | sed 's|/$||')

  # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å­˜åœ¨ç¢ºèª
  if [ ! -d $backup_destination ]; then
    echo $backup_destination is not exists!
    return 1
  else
    # é™¤å¤–ãƒªã‚¹ãƒˆã«å…¥ã£ã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
    local tmp_file2=$(mktemp)
    trap "
      rm $tmp_file
      rm $tmp_file2
      trap - RETURN
    " RETURN
    echo "${exclude_list[@]}" | \
      xargs -n 1 | \
      sed 's|\*$||' > $tmp_file2
    # å†èµ·å‡¦ç†ã«ãªã‚Šãã†ãªã‚‚ã®ãŒã‚ã£ãŸã‚‰ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦å‡ºåŠ›
    # exclude pathã«
    local re2=1
    for exclude in $(cat $tmp_file2); do
      echo $backup_destination | grep -E ^/${exclude} > /dev/null
      if [ "$?" -eq 0 ]; then
        re2=0
      fi
    done
    if [ "$re2" -eq "1" ]; then
      echo $backup_destination is contain backup_file path. >&2
      return $re2
    fi
  fi
  # rsync -e 'ssh -i '
  # ã¨ã„ã†å½¢ã§
  # å·®åˆ†ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãªã®ã§ã€å·®åˆ†ãŒã‚ã‚‹ã¨ã“ã‚ã‚’èª¿ã¹ã‚‹ã€‚
  # logãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¦—ã„ã¦ã€ä¸€ç•ªå¤§ãã„è¡Œã ã‘å–å¾—ã™ã‚‹ã€‚
  local latest_backup_file=$(ls -1 $backup_destination | grep -v .log | sort | sed -n '1p' | xargs -I {} basename {})

  # å·®åˆ†æŒ‡å®šã§å·®åˆ†ãŒã‚ã£ãŸã‚‰ãã‚Œã‚’ä½¿ã†ã€‚ãã‚Œä»¥å¤–ã¯ãƒ•ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
  local comparedest
  if [ ! -z $latest_backup_file ] || [ $diffrental -eq "0" ]; then
    comparedest="--compare-dest=${backup_destination}/${latest_backup_file}"
  fi

  # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆ¤åˆ¥ã™ã‚‹
  local backup_src_filesystem=$(findmnt -m --target / | sed -n '2p' | awk '{print $3}')
  # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å…ˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆ¤åˆ¥ã™ã‚‹
  local backup_dest_filesystem=$(findmnt -m --target ${backup_destination} | sed -n '2p' | awk '{print $3}')

  if [ $backup_src_filesystem != $backup_dest_filesystem ]; then
    echo "backup src filesystem is ${backup_src_filesystem}" >&2
    echo "backup dest filesystem is ${backup_dest_filesystem}" >&2
    echo "filesystem unmatch, acl or user info maybe lost." >&2
    return 1
  fi

  # åˆ¥ã®ã‚·ã‚¹ãƒ†ãƒ ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã‚‹å ´åˆ
  # --numeric-ids
  rsync -aAXv \
    $comparedest \
    $(echo "${exclude_list[@]}" | xargs -n 1 | xargs -I {} echo --exclude {} | xargs) \
    --log-file ${backup_destination}/${suffix_format}.log \
    --info=progress2 \
    $dryrun \
    / \
    ${backup_destination}/${suffix_format}

}

function usage() {
    cat 1>&2 <<EOF
system_bakup
this command 

USAGE::
    system_backup [FLAGS] [OPTIONS]

FLAGS:
    -c, --check-exclude     check-exclude list
    -f                      format for backup
    --system-only           backup exclude /home directory.
    --diffrental            use differential backup.
    --backup-dest           backup destination. roop not permited.
    --add-exclude           add excludes file or directories comman separeted /foo/bar,/awesome/directory,/aaa/bbb/ccc
    --full                  default is fullbackup. conains user directory /home.
    -h, --help              Prints help information
    --dryrun                dry run. check sync process.

OPTIONS:
    --debug                 Set bash debug Option
    --district              If you error occured and not catched, forcfully return. this flag use debug.
    --check-grammer         check bash grammer
    --time                  calculate execute time
EOF
}

function main {

  local i
  local timef=1
  local new_array=( $@ )
  for ((i=0;i<$#;i++)); do
    if [ "${new_array[$i]}" = "--help" ] || [ "${new_array[$i]}" = "-h" ]; then
      usage
      return
    fi
    if [ "${new_array[$i]}" = "--check-grammer" ]; then
      bash -n ${BASH_SOURCE[0]}
      return
    fi
    # set time flag for calculate script time.
    if [ "${new_array[$i]}" = "--time" ]; then
      timef=0
      unset new_array[$i]
    fi
    # if find --debug flag from args, start debug mode.
    if [ "${new_array[$i]}" = "--debug" ]; then
      set -x
      trap "
        set +x
        trap - RETURN
      " RETURN
      unset new_array[$i]
    fi
  done
  # reindex assign.
  new_array=${new_array[@]}

  if [ "$timef" -eq "0" ]; then
    time system_backup $new_array
  else
    system_backup $new_array
  fi
}

main $@

```

## ä½¿ã„æ–¹

ä¸‹è¨˜ã®ã‚³ãƒžãƒ³ãƒ‰ã§ä½¿ã„æ–¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

```bash
system_bakcup -h
```

```bash
# ã‚·ã‚¹ãƒ†ãƒ ã§mountæ¸ˆã¿ã®ãƒ‡ã‚£ã‚¹ã‚¯/run/media/${USER}/dataã¸
# å·®åˆ†ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ã¨ä¿å­˜å…ˆã®ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆãŒ%Y%m%dT%H%M%S%Zã§ä¸€ç•ªæ–°ã—ã„ã‚‚ã®ã¨ã®å·®åˆ†ã‚’å–ã‚‹ã€‚)
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®.cacheãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’é™¤ãå ´åˆ
# (ã‚·ã‚¹ãƒ†ãƒ ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ä¸¡æ–¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—)
system_backup --diffrental --backup-dest /run/media/${USER}/data --add-exclude /home/*/.cache

# ã‚·ã‚¹ãƒ†ãƒ ã®ã¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼é…ä¸‹ã¯é™¤ãã€‚ï¼‰
system_backup --diffrental --system-only --backup-dest /run/media/${USER}/data

## ã‚·ã‚¹ãƒ†ãƒ ã ã‘ã®ãƒ•ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—(--differentalãŒãªã„ã¨ãƒ•ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«ãªã‚‹ã€‚)
system_backup --system-only --backup-dest /run/media/${USER}/data

## --dry-runã‚’å¼•æ•°ã«æ¸¡ã™ã¨dryrun
system_backup --dry-run --diffrental --backup-dest /run/media/${USER}/data --add-exclude /home/*/.cache

## timeã‚’å¼•æ•°ã«æ¸¡ã™ã¨å‡¦ç†æ™‚é–“ã‚’æœ€å¾Œã«è¡¨ç¤º
system_backup --time --diffrental --backup-dest /run/media/${USER}/data --add-exclude /home/*/.cache
```

## æœ€æ–°ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

[github](https://github.com/KatsutoshiOtogawa/shell_script/blob/main/bash/bin/system_backup)

## å‚è€ƒ

[arch linux wiki](https://wiki.archlinux.jp/index.php/Rsync_%E3%81%AB%E3%82%88%E3%82%8B%E3%83%95%E3%83%AB%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%83%90%E3%83%83%E3%82%AF%E3%82%A2%E3%83%83%E3%83%97)