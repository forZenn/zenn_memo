---
title: "Powershellã§é›»æºã‚’ãƒã‚§ãƒƒã‚¯ã§ãã‚‹é–¢æ•°ã‚’å®Ÿè£…ã™ã‚‹"
emoji: "ğŸ“Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["powershell", "dotnet", "cpp", "windows"]
published: true
---

Powershellã«é›»æºã‚’ç¢ºèªã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ãƒ¬ãƒƒãƒˆã¯ç„¡ã„ã§ã™ã€‚
ã‚ˆã£ã¦ã€windowsã®cuiã§ç°¡å˜ã«é›»æºã‚’ç¢ºèªã™ã‚‹æ–¹æ³•ã¯ã‚ã‚Šã¾ã›ã‚“ï¼

å›°ã‚Šã¾ã—ãŸã­ã€‚
ã¨ã„ã†ã“ã¨ã§å®Ÿè£…ã—ã¾ã—ã‚‡ã†ã€‚

ä»Šç¾åœ¨ã€dotnetã«é›»æºã®çŠ¶æ…‹ã‚’å–å¾—ã™ã‚‹æ–¹æ³•ãŒå®Ÿè£…ã•ã‚Œã¦ã„ãªã„ã®ã§ã€csharpã‹ã‚‰C++ã®win32apiã®
é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã€ãã®csharpã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’Powershellã‹ã‚‰èª­ã¿è¾¼ã¿ã€å‹å®šç¾©ã‚’è¡Œã†ã“ã¨ã«ã‚ˆã£ã¦ã€
Powershellã«é–¢æ•°ã®å®šç¾©ã‚’è¡Œã„ã¾ã™ã€‚

ä¸€å¿œã€æœ€è¿‘ã§ããŸcsharpã‹ã‚‰win32ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®[CsWin32](https://github.com/microsoft/CsWin32)ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã†ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€ãƒ“ãƒ«ãƒ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã†ãˆã€dotnet 5.0ä»¥ä¸Šç¸›ã‚ŠãŒã‚ã‚Šã€Powershell7.2ä»¥ä¸Šã§ãªã„ã¨å‹•ä½œã§ããªã„é–¢æ•°ã«ãªã‚Šã¾ã™ã€‚

[GetSystemPowerStatus](https://learn.microsoft.com/ja-jp/windows/win32/api/winbase/nf-winbase-getsystempowerstatus)ã®å®šç¾©ã¯
ã“ã“ã«ã‚ã‚‹ã®ã§ãã‚Œã‚’å‚è€ƒã«csharpå´ã«C++ã¨åŒã˜ä½œã‚Šã®æ§‹é€ ä½“ã‚’ä½œã‚Šä¸Šã’ã€ãã®æ§‹é€ ä½“ã‚’å‚ç…§æ¸¡ã—ã™ã‚‹ã“ã¨ã§å®Ÿç¾ã§ãã¾ã™ã€‚

```cs:Kernel32Dll.cs
using System;
using System.Runtime.InteropServices;

[StructLayout(LayoutKind.Sequential)]
public struct LPSYSTEM_POWER_STATUS {
    public byte ACLineStatus;
    public byte BatteryFlag;
    public byte BatteryLifePercent;
    public byte SystemStatusFlag;
    public uint BatteryLifeTime;
    public uint BatteryFullLifeTime;
}

public class Kernel32Dll {
    [DllImport("Kernel32.dll")]
    private static extern int GetSystemPowerStatus(ref LPSYSTEM_POWER_STATUS lPSYSTEM_POWER_STATUS);

    public static LPSYSTEM_POWER_STATUS GetSystemPowerStatus() {

        var power_status= new LPSYSTEM_POWER_STATUS();

        var result = GetSystemPowerStatus(ref power_status);

        return power_status;

    }
}

```

ã“ã®csharpã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ä¸‹ã®ã‚ˆã†ã«èª­ã¿è¾¼ã¿å®Ÿè¡Œã™ã‚‹ã¨ã€
Powershellã‹ã‚‰é›»æºã®æƒ…å ±ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```powershell
$src = Get-Content Kernel32Dll.cs -Raw

# C++ã®DLLã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
Add-Type -TypeDefinition $src

# DLLå†…ã®é–¢æ•°ã‚’å‘¼ã³å‡ºã—
[Kernel32Dll]::GetSystemPowerStatus()
```

## ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã™ã‚‹å ´åˆ

ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã™ã‚‹å ´åˆã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

ä¸‹è¨˜ã®Kernel32dll.csã¨åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«å…¥ã‚Œã¦ãã ã•ã„ã€‚

```powershell:GetSystemPowerStatus.ps1
$path = (Split-Path $MyInvocation.MyCommand.Path -Parent)
$src = Get-Content (Join-Path $path Kernel32Dll.cs) -Raw

# C++ã®DLLã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
Add-Type -TypeDefinition $src

function Get-SystemPowerStatus {
    param(
    )

    # DLLå†…ã®é–¢æ•°ã‚’å‘¼ã³å‡ºã—
    [Kernel32Dll]::GetSystemPowerStatus()
}
```

ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’Importã™ã‚‹ã¨Get-SystemPowerStatusã‹ã‚‰é›»æºã®æƒ…å ±ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```powershell
Import-Module path/to/GetSystemPowerStatus.ps1

Get-SystemPowerStatus
```

## ã¾ã¨ã‚

C++ã®åŸºç¤ãŒã‚ã‹ã‚‰ã‚“ã¨ã‚­ãƒ„ã‚¤æ°—ã‚‚ã—ã¾ã™ãŒã€ä½•ã¨ã‹ãªã‚‹ã“ã¨ãŒåˆ†ã‹ã£ãŸã¨æ€ã„ã¾ã™ã€‚
ã“ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯powershellï¼•ç³»åˆ—ã§ã‚‚ã€æœ€æ–°ã®dotnet coreç³»ã®Powershellã§ã‚‚æ­£ã—ãå‹•ãã¾ã™ã€‚
